<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Quiz Master - Coaching System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCYwOfdR7Ii5vgW8UN1XRUrX6J0ShOPBOQ",
            authDomain: "retail-quiz-3d431.firebaseapp.com",
            projectId: "retail-quiz-3d431",
            storageBucket: "retail-quiz-3d431.firebasestorage.app",
            messagingSenderId: "807335565097",
            appId: "1:807335565097:web:593c0487b3b2cd269e8938"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'retail-quiz-3d431';

        const mainContainer = document.getElementById('app-container');
        function render(html) { mainContainer.innerHTML = html; }

        let app, auth, db, currentUser, role, currentGameState;

        // ==========================================
        // DATA 10 PERTANYAAN RETAIL
        // ==========================================
        const quizData = [
            { 
                question: "Apa singkatan dari FIFO dalam manajemen stok?", 
                options: ["First In First Out", "First In Fast Out", "Fast In Fast Out", "First In Final Out"], 
                correct: 0 
            },
            { 
                question: "Strategi menata barang di dekat kasir untuk memicu pembelian spontan disebut?", 
                options: ["Window Display", "Impulse Buying Display", "Thematic Display", "Island Display"], 
                correct: 1 
            },
            { 
                question: "Manakah yang merupakan cara terbaik menangani komplain pelanggan?", 
                options: ["Menghindar", "Menyalahkan rekan kerja", "Mendengar & Memberi Solusi", "Meminta pelanggan diam"], 
                correct: 2 
            },
            { 
                question: "Apa tujuan utama dari melakukan 'Stock Opname'?", 
                options: ["Mencari barang hilang saja", "Menghitung laba bersih", "Kecocokan stok fisik & sistem", "Menghabiskan waktu"], 
                correct: 2 
            },
            { 
                question: "Apa istilah untuk menjual produk tambahan yang berhubungan dengan barang yang dibeli pelanggan?", 
                options: ["Down-selling", "Cross-selling", "Out-selling", "Back-selling"], 
                correct: 1 
            },
            { 
                question: "Istilah untuk selisih antara jumlah stok fisik yang tersedia dengan catatan di sistem disebut?", 
                options: ["Shrinkage", "Markup", "Margin", "Overstock"], 
                correct: 0 
            },
            { 
                question: "Teknik 'Up-selling' bertujuan untuk?", 
                options: ["Menurunkan harga", "Menawarkan produk yang lebih murah", "Menawarkan produk dengan kualitas/nilai lebih tinggi", "Menjual produk yang rusak"], 
                correct: 2 
            },
            { 
                question: "Apa yang dimaksud dengan Planogram?", 
                options: ["Diagram rencana toko", "Peta perjalanan karyawan", "Diagram visual tata letak produk di rak", "Rencana promosi bulanan"], 
                correct: 2 
            },
            { 
                question: "Mana di bawah ini yang merupakan indikator keberhasilan penjualan (KPI)?", 
                options: ["Jumlah jam istirahat", "Average Transaction Value (ATV)", "Warna seragam", "Jumlah lampu toko"], 
                correct: 1 
            },
            { 
                question: "Apa tindakan pertama saat menemukan barang yang sudah lewat masa kadaluarsa (Expired)?", 
                options: ["Menurunkan harga", "Menarik dari rak display", "Menjualnya di diskon besar", "Dibiarkan saja"], 
                correct: 1 
            }
        ];

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        showLandingPage();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                render(`<div class="min-h-screen flex items-center justify-center bg-red-50 p-6">Gagal memuat sistem.</div>`);
            }
        }

        function showLandingPage() {
            render(`
                <div class="min-h-screen flex flex-col items-center justify-center bg-blue-600 text-white p-6">
                    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-gray-800 text-center">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-3xl">
                            <i class="fas fa-store"></i>
                        </div>
                        <h1 class="text-3xl font-black mb-2 text-blue-600 italic tracking-tighter uppercase">GASHOOT QUIZ</h1>
                        <p class="text-gray-400 text-sm mb-6">Waktunya Kita Quiz..</p>
                        
                        <input type="text" id="playerName" placeholder="Nama Lengkap Peserta" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-4 text-lg outline-none focus:border-blue-500 transition-all text-center font-bold">
                        
                        <button id="joinBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl text-xl shadow-lg hover:bg-blue-700 active:scale-95 transition mb-3">
                            <i class="fas fa-sign-in-alt mr-2"></i> MASUK LOBBY
                        </button>
                        
                        <button id="hostBtn" class="w-full py-2 text-gray-400 text-xs font-bold uppercase tracking-widest hover:text-blue-500 transition">
                            Login sebagai Analyst (Host)
                        </button>
                    </div>
                </div>
            `);

            document.getElementById('joinBtn').onclick = () => {
                const name = document.getElementById('playerName').value;
                if(name.trim().length < 2) return alert("Masukkan nama yang valid!");
                joinGame(name);
            };
            document.getElementById('hostBtn').onclick = () => becomeHost();
        }

        async function joinGame(name) {
            role = 'player';
            const playerDoc = doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid);
            await setDoc(playerDoc, { name: name.toUpperCase(), score: 0, timestamp: Date.now() });
            listenToGameState();
        }

        async function becomeHost() {
            role = 'host';
            const gameDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            const snap = await getDoc(gameDoc);
            if (!snap.exists()) {
                await setDoc(gameDoc, { currentStep: 'lobby', questionIndex: 0 });
            } else {
                await updateDoc(gameDoc, { currentStep: 'lobby', questionIndex: 0 });
            }
            listenToGameState();
        }

        function listenToGameState() {
            const gameDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            onSnapshot(gameDoc, (snap) => {
                if (snap.exists()) {
                    currentGameState = snap.data();
                    updateUI();
                }
            });
        }

        function updateUI() {
            if (!currentGameState) return;
            switch(currentGameState.currentStep) {
                case 'lobby': showLobby(); break;
                case 'question': showQuestion(); break;
                case 'leaderboard': showLeaderboard(); break;
            }
        }

        function showLobby() {
            render(`
                <div class="min-h-screen bg-blue-700 text-white p-6 flex flex-col items-center">
                    <div class="max-w-5xl w-full flex flex-col items-center">
                        <h1 class="text-4xl md:text-6xl font-black mb-2 italic tracking-tighter">LOBBY PESERTA</h1>
                        <div id="playerCount" class="bg-yellow-400 text-blue-900 px-6 py-2 rounded-full font-black text-xl mb-10 shadow-lg animate-bounce">
                            0 Orang Bergabung
                        </div>
                        
                        <div id="playerList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 w-full mb-12 max-h-[50vh] overflow-y-auto p-4 bg-blue-800/30 rounded-3xl border border-white/10 scrollbar-hide">
                            <!-- Nama peserta muncul di sini -->
                        </div>
                        
                        ${role === 'host' ? `
                            <div class="flex flex-col items-center gap-6 sticky bottom-10 w-full">
                                <button id="startBtn" class="bg-green-500 hover:bg-green-400 text-white px-16 py-6 rounded-full text-3xl font-black shadow-[0_10px_0_0_#15803d] transition-all hover:-translate-y-1 active:translate-y-1 active:shadow-none uppercase">
                                    <i class="fas fa-play mr-3"></i> MULAI KUIS SEKARANG
                                </button>
                                <button id="resetPlayers" class="text-white/40 hover:text-red-400 text-xs font-bold uppercase tracking-widest transition">
                                    <i class="fas fa-sync-alt mr-2"></i> Bersihkan Daftar Peserta
                                </button>
                            </div>
                        ` : `
                            <div class="text-center">
                                <div class="inline-block p-6 bg-white/10 rounded-full mb-4 animate-pulse">
                                    <i class="fas fa-user-clock text-4xl"></i>
                                </div>
                                <p class="text-2xl font-bold italic">Menunggu Analyst memulai kuis...</p>
                                <p class="text-blue-300 mt-2">Nama Anda sudah terdaftar di layar utama.</p>
                            </div>
                        `}
                    </div>
                </div>
            `);

            if (role === 'host') {
                document.getElementById('startBtn').onclick = startQuiz;
                document.getElementById('resetPlayers').onclick = async () => {
                    if(confirm("Hapus semua peserta dan mulai dari nol?")) {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
                        const snap = await getDocs(q);
                        snap.forEach(async (d) => await deleteDoc(d.ref));
                    }
                };
            }

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('playerList');
                const countEl = document.getElementById('playerCount');
                if (!list || !countEl) return;
                
                list.innerHTML = '';
                countEl.innerText = `${snap.size} Orang Bergabung`;
                
                if(snap.empty) {
                    list.innerHTML = '<div class="col-span-full text-center py-10 text-white/20 italic">Belum ada peserta...</div>';
                }

                snap.forEach(doc => {
                    list.innerHTML += `
                        <div class="bg-white text-blue-900 p-4 rounded-2xl font-black shadow-xl text-center text-sm uppercase italic border-b-4 border-blue-200 animate-fade-in flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle text-green-500 text-xs"></i> ${doc.data().name}
                        </div>`;
                });
            });
        }

        async function startQuiz() {
            const gameDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            await updateDoc(gameDoc, { currentStep: 'question', questionIndex: 0, startTime: Date.now() });
        }

        function showQuestion() {
            const q = quizData[currentGameState.questionIndex];
            if (role === 'host') {
                render(`
                    <div class="min-h-screen bg-gray-100 p-6 flex flex-col items-center justify-center">
                        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-4xl text-center border-b-[12px] border-blue-200 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                            <p class="text-blue-600 font-bold mb-4 uppercase tracking-widest italic text-sm">PERTANYAAN ${currentGameState.questionIndex + 1} / ${quizData.length}</p>
                            <h2 class="text-4xl font-black mb-10 text-gray-800 leading-tight">${q.question}</h2>
                            <div class="grid grid-cols-2 gap-6">
                                ${q.options.map((o, idx) => `
                                    <div class="p-6 bg-blue-50 border-2 border-blue-100 rounded-3xl text-2xl font-bold text-blue-900 italic flex items-center">
                                        <span class="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center mr-4 text-sm not-italic shadow-lg">
                                            ${['A','B','C','D'][idx]}
                                        </span>
                                        <span class="text-left">${o}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-8 text-gray-400 text-sm font-bold uppercase italic tracking-widest">
                                Bobot: 70% Akurasi + 30% Kecepatan
                            </div>
                            <button id="showLeaderBtn" class="mt-8 bg-blue-600 text-white px-12 py-5 rounded-full font-black text-2xl hover:bg-blue-700 transition-all shadow-xl hover:scale-105 active:scale-95 uppercase tracking-tighter">
                                LIHAT HASIL SKOR <i class="fas fa-chart-bar ml-2"></i>
                            </button>
                        </div>
                    </div>
                `);
                document.getElementById('showLeaderBtn').onclick = async () => {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), { currentStep: 'leaderboard' });
                };
            } else {
                render(`
                    <div class="min-h-screen bg-blue-600 p-4 flex flex-col items-center justify-center text-white">
                        <div class="text-center mb-8">
                            <h2 class="text-4xl font-black italic uppercase tracking-tighter">JAWAB CEPAT!</h2>
                            <p class="text-blue-200 font-bold italic">Semakin cepat, semakin tinggi skor kecepatan (30%)</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 w-full max-w-md h-[65vh]">
                            <button onclick="sendAnswer(0)" class="bg-red-500 rounded-[2.5rem] text-6xl shadow-xl active:scale-90 border-b-8 border-red-700 transition-transform flex items-center justify-center">A</button>
                            <button onclick="sendAnswer(1)" class="bg-blue-500 rounded-[2.5rem] text-6xl shadow-xl active:scale-90 border-b-8 border-blue-700 transition-transform flex items-center justify-center">B</button>
                            <button onclick="sendAnswer(2)" class="bg-yellow-500 rounded-[2.5rem] text-6xl shadow-xl active:scale-90 border-b-8 border-yellow-700 transition-transform flex items-center justify-center">C</button>
                            <button onclick="sendAnswer(3)" class="bg-green-500 rounded-[2.5rem] text-6xl shadow-xl active:scale-90 border-b-8 border-green-700 transition-transform flex items-center justify-center">D</button>
                        </div>
                    </div>
                `);
            }
        }

        window.sendAnswer = async (i) => {
            const q = quizData[currentGameState.questionIndex];
            let points = 0;
            
            if (i === q.correct) {
                // Bobot 70% dari jawaban benar (700 poin)
                const accuracyScore = 700;
                
                // Bobot 30% dari kecepatan (300 poin)
                // Asumsi batas waktu maksimal untuk kecepatan penuh adalah 20 detik
                const timeTaken = (Date.now() - currentGameState.startTime) / 1000;
                const maxTime = 20; 
                const speedBonus = Math.max(0, Math.floor(300 * ((maxTime - timeTaken) / maxTime)));
                
                points = accuracyScore + speedBonus;
            }
            
            const pDoc = doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid);
            const snap = await getDoc(pDoc);
            const currentScore = snap.exists() ? snap.data().score : 0;
            await updateDoc(pDoc, { score: currentScore + points });
            
            render(`
                <div class="min-h-screen bg-indigo-900 flex flex-col items-center justify-center text-white p-6 text-center">
                    <div class="w-32 h-32 bg-white/10 rounded-full flex items-center justify-center mb-8 animate-bounce">
                        <i class="fas fa-paper-plane text-5xl text-yellow-400"></i>
                    </div>
                    <h2 class="text-5xl font-black uppercase italic tracking-tighter mb-4">TERKIRIM!</h2>
                    <p class="text-indigo-200 text-xl font-bold max-w-xs">Jawaban Anda sudah masuk.</p>
                    <div class="mt-4 px-6 py-2 bg-indigo-800 rounded-full text-sm font-mono text-indigo-300">
                        ${points > 0 ? `Bagus! +${points} Poin` : 'Ups! Jawaban Salah'}
                    </div>
                </div>
            `);
        }

        async function showLeaderboard() {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
            let players = [];
            snap.forEach(d => players.push(d.data()));
            players.sort((a,b) => b.score - a.score);

            const isLastQuestion = currentGameState.questionIndex + 1 >= quizData.length;

            render(`
                <div class="min-h-screen bg-indigo-950 text-white p-6 flex flex-col items-center">
                    <h1 class="text-5xl font-black mb-12 italic tracking-tighter text-yellow-400 uppercase underline decoration-indigo-500 underline-offset-8">KLASEMEN TOP 10</h1>
                    
                    <div class="w-full max-w-3xl space-y-3">
                        ${players.slice(0, 10).map((p, i) => `
                            <div class="flex items-center bg-white/5 p-5 rounded-[2rem] border-l-[12px] ${i==0?'border-yellow-400 scale-105 shadow-2xl shadow-yellow-400/20':'border-white/10'} backdrop-blur-sm transition-all">
                                <span class="text-4xl font-black w-20 text-center italic text-white/50">${i + 1}</span>
                                <span class="flex-grow text-2xl font-black px-4 truncate uppercase italic tracking-tighter">${p.name}</span>
                                <span class="text-4xl font-mono font-black text-yellow-400">${p.score}</span>
                            </div>
                        `).join('')}
                    </div>

                    ${role === 'host' ? `
                        <div class="mt-16 flex flex-col items-center gap-4">
                            <button id="nextBtn" class="bg-white text-indigo-900 px-16 py-6 rounded-full font-black text-3xl hover:bg-yellow-400 transition-all shadow-2xl uppercase active:scale-95">
                                ${isLastQuestion ? 'RESET & SELESAI' : 'PERTANYAAN BERIKUTNYA'} <i class="fas fa-chevron-right ml-2"></i>
                            </button>
                        </div>
                    ` : `
                        <div class="mt-12 text-center text-white/30 font-bold uppercase tracking-[0.4em] animate-pulse italic">
                            ${isLastQuestion ? 'Kuis Selesai! Menunggu Host...' : 'Bersiap untuk ronde selanjutnya...'}
                        </div>
                    `}
                </div>
            `);

            if (role === 'host') {
                document.getElementById('nextBtn').onclick = async () => {
                    const next = currentGameState.questionIndex + 1;
                    if (next < quizData.length) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), { 
                            currentStep: 'question', 
                            questionIndex: next, 
                            startTime: Date.now() 
                        });
                    } else {
                        // Reset skor untuk sesi berikutnya jika host menekan tombol setelah soal terakhir
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
                        const pSnap = await getDocs(q);
                        for (const pDoc of pSnap.docs) {
                            await updateDoc(pDoc.ref, { score: 0 });
                        }
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), { 
                            currentStep: 'lobby', 
                            questionIndex: 0 
                        });
                    }
                };
            }
        }

        window.addEventListener('load', initApp);
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container">
        <div class="min-h-screen flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mb-4"></div>
            <p class="text-blue-600 font-bold animate-pulse uppercase tracking-widest text-xs tracking-widest">SINKRONISASI DATABASE...</p>
        </div>
    </div>
</body>
</html>
