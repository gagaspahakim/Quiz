<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gashoot Quiz Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Tambahkan library Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYwOfdR7Ii5vgW8UN1XRUrX6J0ShOPBOQ",
            authDomain: "retail-quiz-3d431.firebaseapp.com",
            projectId: "retail-quiz-3d431",
            storageBucket: "retail-quiz-3d431.firebasestorage.app",
            messagingSenderId: "807335565097",
            appId: "1:807335565097:web:593c0487b3b2cd269e8938"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'retail-quiz-3d431';

        const mainContainer = document.getElementById('app-container');
        let app, auth, db, currentUser, role, currentGameState;
        let isMusicPlaying = false;
        let confettiInterval = null;
        
        // Audio setup
        const bgMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        bgMusic.loop = true;
        bgMusic.volume = 0.5;

        function render(html) { 
            mainContainer.innerHTML = html;
            renderAudioControl();
        }

        window.toggleMusic = () => {
            if (isMusicPlaying) {
                bgMusic.pause();
                isMusicPlaying = false;
            } else {
                const playPromise = bgMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        isMusicPlaying = true;
                        renderAudioControl();
                    }).catch(error => {
                        console.error("Playback gagal:", error);
                    });
                }
            }
            renderAudioControl();
        };

        function renderAudioControl() {
            let control = document.getElementById('audio-control');
            if (!control) {
                control = document.createElement('div');
                control.id = 'audio-control';
                control.className = 'fixed top-6 right-6 z-50';
                document.body.appendChild(control);
            }
            control.innerHTML = `
                <button onclick="toggleMusic()" class="w-12 h-12 bg-slate-800 border border-slate-700 rounded-full flex items-center justify-center text-white shadow-xl hover:bg-slate-700 transition-all active:scale-90">
                    <i class="fas ${isMusicPlaying ? 'fa-volume-up text-blue-400' : 'fa-volume-mute text-slate-500'}"></i>
                </button>
            `;
        }

        const quizData = [
            { question: "Apa singkatan dari FIFO dalam manajemen stok?", options: ["First In First Out", "First In Fast Out", "Fast In Fast Out", "First In Final Out"], correct: 0 },
            { question: "Strategi menata barang di dekat kasir untuk memicu pembelian spontan disebut?", options: ["Window Display", "Impulse Buying Display", "Thematic Display", "Island Display"], correct: 1 },
            { question: "Manakah yang merupakan cara terbaik menangani komplain pelanggan?", options: ["Menghindar", "Menyalahkan rekan kerja", "Mendengar & Memberi Solusi", "Meminta pelanggan diam"], correct: 2 },
            { question: "Apa tujuan utama dari melakukan 'Stock Opname'?", options: ["Mencari barang hilang saja", "Menghitung laba bersih", "Kecocokan stok fisik & sistem", "Menghabiskan waktu"], correct: 2 },
            { question: "Apa istilah untuk menjual produk tambahan yang berhubungan dengan barang yang dibeli pelanggan?", options: ["Down-selling", "Cross-selling", "Out-selling", "Back-selling"], correct: 1 },
            { question: "Istilah untuk selisih antara jumlah stok fisik yang tersedia dengan catatan di sistem disebut?", options: ["Shrinkage", "Markup", "Margin", "Overstock"], correct: 0 },
            { question: "Teknik 'Up-selling' bertujuan untuk?", options: ["Menurunkan harga", "Menawarkan produk yang lebih murah", "Menawarkan produk dengan kualitas/nilai lebih tinggi", "Menjual produk yang rusak"], correct: 2 },
            { question: "Apa yang dimaksud dengan Planogram?", options: ["Diagram rencana toko", "Peta perjalanan karyawan", "Diagram visual tata letak produk di rak", "Rencana promosi bulanan"], correct: 2 },
            { question: "Mana di bawah ini yang merupakan indikator keberhasilan penjualan (KPI)?", options: ["Jumlah jam istirahat", "Average Transaction Value (ATV)", "Warna seragam", "Jumlah lampu toko"], correct: 1 },
            { question: "Apa tindakan pertama saat menemukan barang yang sudah lewat masa kadaluarsa (Expired)?", options: ["Menurunkan harga", "Menarik dari rak display", "Menjualnya di diskon besar", "Dibiarkan saja"], correct: 1 }
        ];

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        showLandingPage();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                render(`<div class="p-10 text-center text-white">Error connecting to database.</div>`);
            }
        }

        function showLandingPage() {
            render(`
                <div class="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6">
                    <div class="bg-slate-800 border border-slate-700 p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
                        <div class="w-20 h-20 bg-blue-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/20 rotate-3">
                            <i class="fas fa-rocket text-3xl"></i>
                        </div>
                        <h1 class="text-4xl font-black mb-2 bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent italic tracking-tighter uppercase">GASHOOT QUIZ</h1>
                        <p class="text-slate-400 text-xs font-bold tracking-[0.3em] mb-8 uppercase">Retail Mastery Edition</p>
                        
                        <input type="text" id="playerName" placeholder="Nama Peserta..." class="w-full p-4 bg-slate-900 border border-slate-700 rounded-2xl mb-4 text-center font-bold outline-none focus:border-blue-500 transition-all text-white">
                        
                        <button id="joinBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl text-xl shadow-xl transition-all active:scale-95 mb-4 uppercase italic">
                            Masuk Lobby
                        </button>
                        
                        <button id="hostBtn" class="text-slate-500 text-[10px] font-bold uppercase tracking-widest hover:text-blue-400 transition">
                            Login sebagai Analyst
                        </button>
                    </div>
                    <p class="mt-8 text-slate-500 text-xs italic">Klik ikon speaker di pojok atas jika musik tidak mulai otomatis.</p>
                </div>
            `);

            document.getElementById('joinBtn').onclick = () => {
                const name = document.getElementById('playerName').value;
                if(name.trim().length < 2) return alert("Nama minimal 2 karakter!");
                if(!isMusicPlaying) window.toggleMusic();
                joinGame(name);
            };
            
            document.getElementById('hostBtn').onclick = () => {
                if(!isMusicPlaying) window.toggleMusic();
                becomeHost();
            };
        }

        async function joinGame(name) {
            role = 'player';
            const playerDoc = doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid);
            await setDoc(playerDoc, { name: name.toUpperCase(), score: 0, timestamp: Date.now() });
            listenToGameState();
        }

        async function becomeHost() {
            role = 'host';
            const gameDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            await setDoc(gameDoc, { currentStep: 'lobby', questionIndex: 0 }, { merge: true });
            listenToGameState();
        }

        function listenToGameState() {
            const gameDoc = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            onSnapshot(gameDoc, (snap) => {
                if (snap.exists()) {
                    currentGameState = snap.data();
                    updateUI();
                }
            });
        }

        function updateUI() {
            if (!currentGameState) return;
            
            // Hentikan confetti jika pindah langkah selain leaderboard final
            if (confettiInterval) {
                clearInterval(confettiInterval);
                confettiInterval = null;
            }

            switch(currentGameState.currentStep) {
                case 'lobby': showLobby(); break;
                case 'question': showQuestion(); break;
                case 'leaderboard': showLeaderboard(); break;
            }
        }

        window.resetGameData = async () => {
            if (!confirm("Apakah Anda yakin ingin menghapus SEMUA data pemain dan kembali ke awal?")) return;
            
            const batch = writeBatch(db);
            const playerSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
            playerSnap.forEach(doc => batch.delete(doc.ref));
            
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main');
            batch.set(gameRef, { currentStep: 'lobby', questionIndex: 0 });
            
            await batch.commit();
            location.reload(); 
        };

        function showLobby() {
            render(`
                <div class="min-h-screen bg-slate-950 text-white p-6 flex flex-col items-center">
                    <div class="max-w-5xl w-full text-center mt-10">
                        <h1 class="text-5xl font-black mb-2 italic tracking-tighter uppercase">LOBBY <span class="text-blue-500">PESERTA</span></h1>
                        <div id="playerCount" class="inline-block bg-blue-600/20 text-blue-400 px-6 py-2 rounded-full font-black text-sm mb-12 border border-blue-500/30">
                            0 Orang Bergabung
                        </div>
                        
                        <div id="playerList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-20"></div>
                        
                        ${role === 'host' ? `
                            <div class="fixed bottom-10 left-1/2 -translate-x-1/2 w-full max-w-md px-6 flex flex-col gap-4">
                                <button id="startBtn" class="w-full bg-blue-600 text-white px-8 py-4 rounded-2xl text-2xl font-black shadow-2xl hover:bg-blue-500 transition-all uppercase italic">
                                    Mulai Kuis
                                </button>
                                <button onclick="resetGameData()" class="text-rose-500 text-xs font-bold uppercase tracking-widest hover:text-rose-400 transition">
                                    <i class="fas fa-trash-alt mr-2"></i> Reset Seluruh Data & Pemain
                                </button>
                            </div>
                        ` : `
                            <div class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800">
                                <p class="text-slate-500 animate-pulse font-bold italic uppercase tracking-widest">Menunggu Analyst memulai kuis...</p>
                            </div>
                        `}
                    </div>
                </div>
            `);

            if (role === 'host') {
                document.getElementById('startBtn').onclick = () => 
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), 
                    { currentStep: 'question', questionIndex: 0, startTime: Date.now() });
            }

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('playerList');
                const countEl = document.getElementById('playerCount');
                if (!list || !countEl) return;
                list.innerHTML = '';
                countEl.innerText = `${snap.size} Orang Bergabung`;
                snap.forEach(doc => {
                    list.innerHTML += `
                        <div class="bg-slate-800 border border-slate-700 p-4 rounded-2xl font-bold text-xs uppercase truncate">
                            ${doc.data().name}
                        </div>`;
                });
            });
        }

        function showQuestion() {
            const q = quizData[currentGameState.questionIndex];
            if (role === 'host') {
                render(`
                    <div class="min-h-screen bg-slate-900 p-6 flex flex-col items-center justify-center text-white text-center">
                        <div class="max-w-4xl w-full">
                            <p class="text-blue-400 font-black mb-4 uppercase tracking-[0.3em] text-xs">Pertanyaan ${currentGameState.questionIndex + 1} / 10</p>
                            <h2 class="text-4xl md:text-5xl font-black mb-12 leading-tight italic tracking-tight">${q.question}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                ${q.options.map((o, idx) => `
                                    <div class="p-6 bg-slate-800 border border-slate-700 rounded-3xl text-xl font-bold flex items-center">
                                        <span class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center mr-4 text-sm">${['A','B','C','D'][idx]}</span>
                                        ${o}
                                    </div>
                                `).join('')}
                            </div>
                            <button id="showLeaderBtn" class="mt-12 bg-blue-600 px-10 py-4 rounded-full font-black text-xl hover:bg-blue-500 transition-all shadow-lg uppercase italic">
                                Lihat Hasil Skor
                            </button>
                        </div>
                    </div>
                `);
                document.getElementById('showLeaderBtn').onclick = () => 
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), { currentStep: 'leaderboard' });
            } else {
                render(`
                    <div class="min-h-screen bg-slate-900 p-4 flex flex-col justify-center items-center">
                         <p class="text-blue-400 font-black mb-6 uppercase tracking-[0.3em] text-xs text-center">Pilih Jawaban di Layar Anda</p>
                        <div class="grid grid-cols-2 gap-4 w-full h-[60vh] max-w-md">
                            <button onclick="sendAnswer(0)" class="bg-rose-500 rounded-[2.5rem] text-5xl font-black text-white shadow-[0_8px_0_0_#9f1239] active:translate-y-1 active:shadow-none transition-all">A</button>
                            <button onclick="sendAnswer(1)" class="bg-blue-500 rounded-[2.5rem] text-5xl font-black text-white shadow-[0_8px_0_0_#1e40af] active:translate-y-1 active:shadow-none transition-all">B</button>
                            <button onclick="sendAnswer(2)" class="bg-amber-500 rounded-[2.5rem] text-5xl font-black text-white shadow-[0_8px_0_0_#92400e] active:translate-y-1 active:shadow-none transition-all">C</button>
                            <button onclick="sendAnswer(3)" class="bg-emerald-500 rounded-[2.5rem] text-5xl font-black text-white shadow-[0_8px_0_0_#065f46] active:translate-y-1 active:shadow-none transition-all">D</button>
                        </div>
                    </div>
                `);
            }
        }

        window.sendAnswer = async (i) => {
            const q = quizData[currentGameState.questionIndex];
            let points = 0;
            if (i === q.correct) {
                const timeTaken = (Date.now() - currentGameState.startTime) / 1000;
                points = 700 + Math.max(0, Math.floor(300 * ((20 - timeTaken) / 20)));
            }
            const pDoc = doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid);
            const snap = await getDoc(pDoc);
            await updateDoc(pDoc, { score: (snap.data()?.score || 0) + points });
            
            render(`
                <div class="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-white p-6 text-center">
                    <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mb-6 animate-bounce">
                        <i class="fas fa-paper-plane text-emerald-500 text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-black italic uppercase tracking-tighter">JAWABAN TERKIRIM</h2>
                    <p class="text-slate-500 text-sm mt-4 font-bold uppercase tracking-widest">Analyst sedang meninjau klasemen...</p>
                </div>
            `);
        }

        function triggerConfetti() {
            const end = Date.now() + (2 * 1000);
            const colors = ['#3b82f6', '#22d3ee', '#ffffff'];

            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: colors
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: colors
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        async function showLeaderboard() {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'players'));
            let players = [];
            snap.forEach(d => players.push(d.data()));
            players.sort((a,b) => b.score - a.score);

            const isLast = currentGameState.questionIndex + 1 >= quizData.length;

            // Jika ini soal terakhir, nyalakan confetti berulang
            if (isLast && !confettiInterval) {
                triggerConfetti();
                confettiInterval = setInterval(triggerConfetti, 3000);
            }

            render(`
                <div class="min-h-screen bg-slate-950 text-white p-6 flex flex-col items-center">
                    <h1 class="text-4xl font-black mb-10 italic tracking-tighter text-blue-400 uppercase mt-10">
                        ${isLast ? 'üèÜ PEMENANG FINAL' : 'KLASEMEN SEMENTARA'}
                    </h1>
                    <div class="w-full max-w-2xl space-y-3 mb-24 relative z-10">
                        ${players.slice(0, 10).map((p, i) => `
                            <div class="flex items-center bg-slate-900 border border-slate-800 p-5 rounded-2xl ${i==0?'border-blue-500 bg-blue-500/10 shadow-[0_0_30px_rgba(59,130,246,0.2)] scale-105 mb-4':''}">
                                <span class="text-2xl font-black w-10 text-slate-500 italic">
                                    ${i == 0 ? 'üëë' : i + 1}
                                </span>
                                <span class="flex-grow text-lg font-bold uppercase italic ${i==0?'text-blue-400':''}">${p.name}</span>
                                <span class="text-2xl font-mono font-black ${i==0?'text-blue-400':'text-slate-400'}">${p.score}</span>
                            </div>
                        `).join('')}
                    </div>

                    ${role === 'host' ? `
                        <div class="fixed bottom-10 left-1/2 -translate-x-1/2 w-full max-w-xs flex flex-col gap-4 px-6 z-20">
                            <button id="nextBtn" class="w-full bg-white text-slate-950 px-10 py-4 rounded-2xl font-black text-xl hover:bg-blue-400 transition-all uppercase italic shadow-2xl">
                                ${isLast ? 'Tutup & Reset' : 'Soal Berikutnya'}
                            </button>
                        </div>
                    ` : `
                         <div class="fixed bottom-10 text-slate-500 text-xs font-bold uppercase tracking-widest animate-pulse">
                            ${isLast ? 'Permainan Selesai!' : 'Analyst akan melanjutkan ke soal berikutnya'}
                        </div>
                    `}
                </div>
            `);

            if (role === 'host') {
                document.getElementById('nextBtn').onclick = async () => {
                    const next = currentGameState.questionIndex + 1;
                    if (next < quizData.length) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameStatus', 'main'), { currentStep: 'question', questionIndex: next, startTime: Date.now() });
                    } else {
                        await resetGameData();
                    }
                };
            }
        }

        window.onload = initApp;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; overflow-x: hidden; }
        button { touch-action: manipulation; }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="h-screen flex items-center justify-center text-blue-500 font-bold animate-pulse uppercase tracking-widest">
            SINKRONISASI DATA...
        </div>
    </div>
</body>
</html>
